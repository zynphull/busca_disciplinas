<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>USP - Busca Disciplina</title>
		<link href="css/bootstrap-min.css" rel="stylesheet"/>
		<link href="css/bootstrap-theme-min.css" rel="stylesheet"/>
		<link href="css/styles.css" rel="stylesheet" type="text/css"/>
		<style>
			.morecontent {
				text-align: justify;
				text-justify: inter-word;
				width: 95%;
			}
			.creditos {
				font-size: 12px;
				font-weight: semibold;
			}
		</style>
		<script src="js/jquery-2.1.1.min.js"></script>
		<script src="js/jquery.shorten.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script>
			// initiates global variables
			var unit_set = Array.new;

			$(document).ready(function() {
				$.getJSON('data.json'); // downloads relevant json data

				// delegate event listener to watch for changes in Unit select's option and filter results
				$('div').on('change', '#unit-sel', function() {
					var selected = $('select option:selected').text(); //checks which unit is selected
					var unitrows = $('.unit-row');
					if (selected == "Unidade") // if default option is selected, clear filter
					{
						unitrows.removeClass('hidden');
						unitrows.next().removeClass('hidden');
					}
					else //otherwise just filter for selected Unit
					{
						// hides all course rows
						unitrows.addClass('hidden');
						unitrows.next().addClass('hidden');
						// shows only the relevant ones
						$('tr[data-unit="'+selected+'"').removeClass('hidden');
						$('tr[data-unit="'+selected+'"').next().removeClass('hidden');
					}
				});
			});

			// method to return Unit's acronyms, given their full names
			function gera_sigla(fullname)
			{
				pairs = {
					"Pr%C3%B3-Reitoria%20de%20Gradua%C3%A7%C3%A3o%20-%20Cursos%20Interunidades": "PRG",
					"Instituto%20de%20Estudos%20Brasileiros": "IEB",
					"Escola%20de%20Comunica%C3%A7%C3%B5es%20e%20Artes": "ECA",
					"Faculdade%20de%20Direito": "FDUSP"
				}
				return pairs[fullname];
			}

			function str2reg(str1)
			{ //function that splits a string into an array of words, wraps each like (?=.*word) and puts them back together
				str1 = str1.split(' '); // splits str1
				while (str1.indexOf('') != -1) // erases blank entries from array, preventing multiple SPACE chars
					str1.splice([str1.indexOf('')],1);
				var str2 = ''; // second string to concat all others
				var input = $('#search').val(); // gets raw input text
				last_word = str1[str1.length - 1]; // extracts last word
				str1.pop(); // pops last word. str1 may have 0 or more words now
				// if it has 0 word, it'll skip the IF, as last_word contains its only word and will be taken care of below
				// if it has 1 or + words, it'll enter the if, add a \b to it, and leave
				// after skipping, line "str2 += '(?=.*\\b'+ last_word;" append the only word 
				if (str1.length >= 1)
				{
					$.each(str1, function(index, word) {
						word = '(?=.*\\b'+ word +'\\b)'; // wraps it in regex lookahead
						str2 = str2.concat(word);
					});
				}
				str2 += '(?=.*\\b'+ last_word;
				if (input[input.length - 1] == ' ') // if last char on search box is space, close last word
					str2 += '\\b';
				str2 += ')';
				return str2;
			}

			$(window).load(function()
			{
				$('#search').keyup(function()
				{
					$('#form').submit(function() {
  						return false;
					});

					var searchField = $('#search').val(); // saves current form value to variable
					if (!searchField)
					{
						$('#results').empty();
					}
					else
					{
						searchField = str2reg(searchField); // splits input's words
						var regex = new RegExp(searchField, "i"); // creates new RegExp object with case-insensitive match on the previous variable
						var output = ''; // starts printing output
						var count = 1;
						var found = 0;

						$.getJSON('data.json', function(data)
						{
							unit_set = [];
							$.each(data, function(key, val) // here, the key is an integer INDEX and val is an OBJECT, since this 'data' is an ARRAY
							{
								var present = false; // at first there are no occurrences in this val
								var i = 0;
								$.each(val, function(cat, cont) {
									if (cont.search(regex) != -1) // has it found a match?
										present = true;
									i++;
									if (present == true || i > 12) // if it finds a match or reaches the end of searchable part of obj, break
										return false;
								});
								if (present == true) // if so, I found a match in this value(course)
								{
									found++;
									var sigla = gera_sigla(encodeURI(val.unidade));
									if (unit_set.indexOf(sigla) == -1) // creating a list of units found
										unit_set.push(sigla); // if unit wasn't already listed, push it into the list
									output += '<tr class="unit-row" data-unit="'+sigla+'">';
									var code;
									for (var i = 13, code = val.nome[12]; i < 19; i++) // extracts course code
										code += val.nome[i];
									realNome = val.nome.slice(22,val.nome.length);
									//output += '<div class="col-md-12 item-materia">';
									output += '<td><h6><span data-toggle="tooltip" title="' + val.unidade + '">' + sigla + '</span></h6></td>';
									output += '<td><h5><strong>' + code + ' - ';
									output += '<a href="https://uspdigital.usp.br/jupiterweb/obterDisciplina?sgldis=' + code + '">' + realNome + '</a></h5></td></tr>';
									output += '<tr><td style="width: 92px"><table class="creditos">';
									output += '<tr><td data-toggle="tooltip" title="Créditos-aula"><strong>CA</strong>: '+ val.cred_aula + '</td></tr>'+'<tr><td data-toggle="tooltip" data-placement="bottom" title="Créditos-trabalho"><strong>CT</strong>: '+ val.cred_trab + '</td></tr></table><td><h6 class="morecontent"><span>' + val.programa + '</span></h6></td></tr>';
									if(count % 2 == 0)
									{
										output += '</tr>'
									}
									count++;
								}
							});
							output += '</tbody></table></div>';
							output_final = '<div class="panel panel-default"><div class="panel-heading">Disciplinas encontradas: '+ found +'</div><table class="table table-responsive table-striped"><thead><tr><th><select id="unit-sel" class="form-control input-sm"><option value="clear">Unidade</option>';
							$.each(unit_set, function(ind, unit) {
								output_final += '<option value="'+ unit + '">'+ unit +'</option>';
							});
							output_final += '</select></th><th>Disciplina</th></tr><tbody>'.concat(output); //prints output header
							$('#results').html(output_final); // generates query results

							$('[data-toggle="tooltip"]').tooltip({ // enables tooltips on dpt names
								'data-placement': 'bottom',
							}); 

							$('.morecontent').shorten({
								moreText: '>>',
								lessText: '<<',
								showChars: '500'
							}); // shortens descriptions
						});
					}
				});
			});
		</script>
	</head>

	<body>
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) return;
			js = d.createElement(s); js.id = id;
			js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&appId=300550970089564&version=v2.0";
			fjs.parentNode.insertBefore(js, fjs);
		}
		(document, 'script', 'facebook-jssdk'));
		</script>

		<div id="main" class="container">
			<div id="header">
				<h1><strong>Busca de disciplinas da USP</strong></h1>
				<p>Procurando por optativas de seu interesse? Ou só querendo descobrir quantas matérias falam sobre RPG (dica: não são muitas) ? Aqui você pode buscar matérias pelo conteúdo de suas páginas no JúpiterWeb, não só pelo nome, e encontrar o que você procura :3</p>
				<p>Digite abaixo os termos para buscá-los no nome, unidade, curso/departamento, programa e objetivos das disciplinas da USP. Sugere-se que você use palavras-chave simples como <code>direito</code>, <code>filosofia</code>, <code>educação</code>, etc. para encontrar o máximo de resultados possível.</p>
				<p>A busca pode demorar alguns segundos para exibir os resultados, aguarde.</p>
			</div>
			<div class="form-group has-feedback">
				<input autocomplete="off" autofocus class="form-control input-lg" id="search" placeholder="O que você procura?" type="text">
				<span class="glyphicon glyphicon-search form-control-feedback" aria-hidden="true"></span>
			</div>
			<div id="results"></div>
			<div class="fb-like" data-href="http://rafaelviana.com.br/busca_usp/" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
		</div>
	</body>
</html>